<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Plagiarism Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        .hidden { display: none; }
        pre { background-color: #f8f8f8; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-md mx-auto p-6">
        <!-- Error/Message Display -->
        <div id="message" class="hidden mb-4"></div>

        <!-- Registration Section -->
        <div id="register" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Register</h2>
            <form id="registerForm" class="space-y-4">
                <input type="email" id="email1" placeholder="Primary Email" required class="w-full p-2 border border-gray-300 rounded">
                <input type="email" id="email2" placeholder="Secondary Email" required class="w-full p-2 border border-gray-300 rounded">
                <input type="password" id="password" placeholder="Password" required class="w-full p-2 border border-gray-300 rounded">
                <input type="text" id="handle" placeholder="Handle" required class="w-full p-2 border border-gray-300 rounded">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Register</button>
            </form>
        </div>

        <!-- Login Section -->
        <div id="login" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Login</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" required class="w-full p-2 border border-gray-300 rounded">
                <input type="password" id="loginPassword" placeholder="Password" required class="w-full p-2 border border-gray-300 rounded">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
            </form>
            <p class="mt-4">Don't have an account? <a href="#" id="registerLink" class="text-blue-500">Register here</a></p>
        </div>

        <!-- Analyze Code Section -->
        <div id="analyze" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Analyze Code</h2>
            <form id="analyzeForm" class="space-y-4">
                <textarea id="code" placeholder="Paste your code here" required class="w-full p-2 border border-gray-300 rounded h-48"></textarea>
                <input type="text" id="analyzeHandle" placeholder="Your Handle" required class="w-full p-2 border border-gray-300 rounded">
                <select id="language" class="w-full p-2 border border-gray-300 rounded">
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                </select>
                <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Analyze</button>
            </form>
            <div id="result" class="mt-4 text-gray-700"></div>
            <button id="logout" class="mt-4 bg-red-500 text-white p-2 rounded hover:bg-red-600">Logout</button>
        </div>
    </div>

    <script>
        // Function to show the specified section and hide others
        function showSection(sectionId) {
            ['register', 'login', 'analyze'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== sectionId);
            });
            document.getElementById('message').classList.add('hidden');
        }

        // Function to display messages
        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.classList.remove('hidden', 'text-green-500', 'text-red-500');
            messageDiv.classList.add(isError ? 'text-red-500' : 'text-green-500');
        }

        // Check user state on page load
        window.addEventListener('load', async function() {
            const registered = localStorage.getItem('registered') === 'true';
            const accessToken = localStorage.getItem('accessToken');

            if (!registered) {
                showSection('register');
            } else if (!accessToken) {
                showSection('login');
            } else {
                try {
                    const response = await fetch('/health', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (response.ok) {
                        showSection('analyze');
                    } else {
                        localStorage.removeItem('accessToken');
                        showSection('login');
                    }
                } catch {
                    localStorage.removeItem('accessToken');
                    showSection('login');
                }
            }
        });

        // Handle registration form submission
        document.getElementById('registerForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email1 = document.getElementById('email1').value;
            const email2 = document.getElementById('email2').value;
            const password = document.getElementById('password').value;
            const handle = document.getElementById('handle').value;

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ email1, email2, password, handle })
                });
                const text = await response.text();
                if (response.ok) {
                    localStorage.setItem('registered', 'true');
                    showSection('login');
                    showMessage('Registration successful. Please log in.');
                } else {
                    const errorMatch = text.match(/<p class="text-red-500 mb-4">(.+?)<\/p>/);
                    showMessage(errorMatch ? errorMatch[1] : 'Registration failed', true);
                }
            } catch {
                showMessage('Error: Could not connect to server', true);
            }
        });

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ email, password })
                });
                if (response.ok) {
                    const setCookie = response.headers.get('set-cookie');
                    const accessToken = setCookie?.match(/access_token=([^;]+)/)?.[1];
                    if (accessToken) {
                        localStorage.setItem('accessToken', accessToken);
                        showSection('analyze');
                        showMessage('Login successful');
                    } else {
                        showMessage('Login failed: No token received', true);
                    }
                } else {
                    const text = await response.text();
                    const errorMatch = text.match(/<p class="text-red-500 mb-4">(.+?)<\/p>/);
                    showMessage(errorMatch ? errorMatch[1] : 'Login failed', true);
                }
            } catch {
                showMessage('Error: Could not connect to server', true);
            }
        });

        // Handle analyze form submission
        document.getElementById('analyzeForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const code = document.getElementById('code').value;
            const handle = document.getElementById('analyzeHandle').value;
            const language = document.getElementById('language').value;
            const accessToken = localStorage.getItem('accessToken');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: new URLSearchParams({ code, handle, language })
                });
                const text = await response.text();
                if (response.ok) {
                    const resultMatch = text.match(/<script>window\.result = ({.+?});<\/script>/s);
                    const result = resultMatch ? JSON.parse(resultMatch[1]) : {};
                    const report = result?.result?.report || 'No report generated';
                    const submittedCode = result?.result?.code || code;
                    document.getElementById('result').innerHTML = `
                        <h3 class="text-lg font-semibold mt-4">Submitted Code:</h3>
                        <pre>${submittedCode}</pre>
                        <h3 class="text-lg font-semibold mt-4">Analysis Result:</h3>
                        <pre>${report}</pre>
                    `;
                } else {
                    const errorMatch = text.match(/<p class="text-red-500 mb-4">(.+?)<\/p>/);
                    showMessage(errorMatch ? errorMatch[1] : 'Analysis failed', true);
                }
            } catch {
                showMessage('Error: Could not connect to server', true);
            }
        });

        // Handle logout
        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('accessToken');
            showSection('login');
            showMessage('Logged out successfully');
        });

        // Handle register link
        document.getElementById('registerLink').addEventListener('click', function(event) {
            event.preventDefault();
            showSection('register');
        });
    </script>
</body>
</html>
